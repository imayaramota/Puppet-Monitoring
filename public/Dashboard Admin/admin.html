<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet"
        href="https://maxst.icons8.com/vue-static/landings/line-awesome/line-awesome/1.3.0/css/line-awesome.min.css">
    <link rel="stylesheet" href="./style/adminStyle.css">
    <script src="../js/funcoes.js"></script>
    <link rel="icon" href="./assets/LogoRoxo.png">
    <script src="https://code.jivosite.com/widget/5q0iqZqyVo" async></script>
</head>
<style>
    .tooltip {
        position: relative;
        display: inline-block;
    }

    .tooltip img {
        width: 15px;
        height: 15px;
    }

    .tooltip .tooltiptext {
        visibility: hidden;
        width: 120px;
        background-color: #6db305;
        color: #fff !important;
        text-align: center;
        border-radius: 6px;
        padding: 5px 0;
        font-size: smaller !important;

        /* Position the tooltip */
        position: absolute;
        z-index: 1;
    }

    .tooltip:hover .tooltiptext {
        visibility: visible;
    }
</style>

<body>
    <!--Menu Lateral-->
    <input type="checkbox" id="nav-toggle">
    <div class="barraLateral">
        <div class="barraLateralLogo">
            <h2><span>PUPPET</span></h2>
        </div>
        <div class="barraLateralMenu">
            <ul>
                <li class="list active">
                    <a href="./admin.html">
                        <span class="las la-window-restore"></span>
                        <span>Geral</span>
                    </a>
                </li>
                <li class="list">
                    <a href="./listarUsuarios.html">
                        <span class="las la-users"></span>
                        <span>Usuários</span>
                    </a>
                </li>
                <li class="list">
                    <a href="./listagemMaquina.html">
                        <span class="las la-server"></span>
                        <span>Máquinas virtuais</span>
                    </a>
                </li>
                <li class="list">
                    <a href="#">
                        <span class="las la-cog"></span>
                        <span id="sair">Sair</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
    <!--Header-->
    <div class="mainContent">
        <header>
            <h2>
                <label for="nav-toggle">
                    <span class="las la-bars"></span>
                </label>
                Geral
            </h2>
            <div class="usuario">
                <img src="./assets/whindUsuario.jpg" width="40px" height="40px" alt="">
                <div>
                    <h3><span id="b_usuario"></span></h3>

                    <small id="setor_usuario"></small>
                </div>
            </div>
        </header>
        <!--Parte dos cards/main-->
        <main>
            <div class="cards">
                <div class="cardSingle">
                    <div>
                        <h1 id="contadorSttsVerde">0</h1>
                        <span>Servidores em estado ótimo</span>
                        <div class="tooltip">
                            <img src="https://cdn.iconscout.com/icon/free/png-256/information-notice-info-ui-tooltip-guide-30515.png"
                                alt="">
                            <span class="tooltiptext" style="background-color: #6db305;"><b>Ótimo Estado(acima de 0 á 50%)</b><br>
                                Após análises o estado da CPU, RAM e
                                Disco <b>não</b> apresentam riscos de lentidão e baixo processamento.
                            </span>
                        </div>
                    </div>
                    <div>
                        <span class="las la-server"></span>
                    </div>
                </div>
                <div class="cardSingle">
                    <div>
                        <h1 id="contadorSttsAmarelo">0</h1>
                        <span>Servidores em estado razoável</span>
                        <div class="tooltip">
                            <img src="https://cdn.iconscout.com/icon/free/png-256/information-notice-info-ui-tooltip-guide-30515.png"
                                alt="">
                            <span class="tooltiptext" style="background-color: #ffc411"><b>Estado Razoável(acima de 50 á 65%)</b><br>
                                Após análises o estado da CPU, RAM e
                                Disco apresentam <b>pouco</b> riscos de lentidão e baixo processamento.
                            </span>
                        </div>
                    </div>
                    <div>
                        <span class="las la-server"></span>
                    </div>
                </div>
                <div class="cardSingle">
                    <div>
                        <h1 id="contadorSttsLaranja">0</h1>
                        <span>Servidores em estado preocupante</span>
                        <div class="tooltip">
                            <img src="https://cdn.iconscout.com/icon/free/png-256/information-notice-info-ui-tooltip-guide-30515.png"
                                alt="">
                            <span class="tooltiptext" style="background-color: #f39e00">
                                <b>Estado Preocupante(acima de 65 á 75%)</b><br>
                                Após análises o estado da CPU, RAM e
                                Disco apresentam riscos <b>consideráveis</b> de lentidão e baixo processamento.
                            </span>
                        </div>
                    </div>
                    <div>
                        <span class="las la-server"></span>
                    </div>
                </div>
                <div class="cardSingle">
                    <div>
                        <h1 id="contadorSttsVermelho">0</h1>
                        <span>Servidores em estado crítico</span>
                        <div class="tooltip">
                            <img src="https://cdn.iconscout.com/icon/free/png-256/information-notice-info-ui-tooltip-guide-30515.png"
                                alt="">
                            <span class="tooltiptext" style="background-color: #e20b0b"><b>Estado Crítico(acima de 75%)</b><br>
                                Após análises o estado da CPU, RAM e
                                Disco apresentam <b>muitos</b> riscos de lentidão e baixo processamento.
                            </span>
                        </div>
                    </div>
                    <div>
                        <span class="las la-server"></span>
                    </div>
                </div>
            </div>
            <div class="listagemColunasGrafico" id="listagemGrafico"></div>
    </div>
    </div>
    </div>
    </div>
    </div>
    </main>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.8.0/chart.min.js"
        integrity="sha512-sW/w8s4RWTdFFSduOTGtk4isV1+190E/GghVffMA9XczdJ2MDzSzLEubKAs5h0wzgSJOQTRYyaz73L3d6RtJSg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>

        b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
        setor_usuario.innerHTML = sessionStorage.SETOR_USUARIO;
        //  keyVM_maquina.innerHTML = sessionStorage.KEY_VM;

        fetch("/maquinas/" + sessionStorage.ID_USUARIO, {
            method: "GET",
        }).then(function (resposta) {
            resposta.json().then(json => {
                listar_maq(json)
            });
        }).catch(function (erro) {
            console.log(erro);
        })

        function listar_maq(maquinas) {
            maquinas.forEach(function (maquina) {
                if (maquina.hostName != null) {
                    listagemGrafico.innerHTML += `
                        <div class="cardGrafico">
                            <h3>${[maquina.nome]}</h3>
                            <div class="parteGrafico">
                                <canvas id="myChart${[maquina.id]}"></canvas>
                            </div>
                        </div>
                    `;
                    
                    informacoesMaquina(maquinas.id);
                    setInterval(() => {
                        atualizarGraficos(maquina)
                    }, 5000)
                }

            });
        }

        var graficos = [];
        var statusMaq = [];

        function atualizarGraficos(maquina) {
            fetch(`/medidas/ultimas/${maquina.id}`, { cache: 'no-store' }).then(function (response) {
                if (response.ok) {
                    if (response.statusText == "OK") {
                        response.json().then(function (resposta) {
                            resposta.reverse();

                            let usoDisco = [];
                            let usoRam = [];
                            let usoProcessador = [];
                            let dataHora = [];

                            resposta.forEach(function (dados) {
                                usoDisco.push(dados.usoDisco * 100);
                                usoRam.push(dados.usoRam);
                                usoProcessador.push(dados.usoProcessador);
                                dataHora.push(dados.dataHora);
                            });

                            if (typeof graficos[maquina.id] === 'undefined') {

                                const data = {
                                    labels: dataHora,
                                    datasets: [
                                        {
                                            label: 'Uso Processador',
                                            data: usoProcessador,
                                            borderColor: '#260c4b',
                                            backgroundColor: '#260c4b'
                                        },
                                        {
                                            label: 'Uso Disco',
                                            data: usoDisco,
                                            borderColor: '#991472',
                                            backgroundColor: '#991472',
                                        },
                                        {
                                            label: 'Uso Ram',
                                            data: usoRam,
                                            borderColor: '#07e4ff',
                                            backgroundColor: '#07e4ff',
                                        }
                                    ]
                                };

                                config = {
                                    type: 'line',
                                    data: data,
                                    options: {
                                        responsive: true,
                                        plugins: {
                                            legend: {
                                                position: 'top',
                                            },
                                        }
                                    },
                                };


                                graficos[maquina.id] = new Chart(document.getElementById('myChart' + maquina.id), config);
                                if (usoDisco[0] <= 50 && usoProcessador[0] <= 50 && usoRam[0] <= 50) {
                                    statusMaq[maquina.id] = "Status Verde";
                                    contadorSttsVerde.innerHTML++;
                                } else if (usoDisco[0] <= 65 && usoProcessador[0] <= 65 && usoRam[0] <= 65) {
                                    statusMaq[maquina.id] = "Status Amarelo";
                                    contadorSttsAmarelo.innerHTML++;
                                } else if (usoDisco[0] <= 75 && usoProcessador[0] <= 75 && usoRam[0] <= 75) {
                                    statusMaq[maquina.id] = "Status Laranja";
                                    contadorSttsLaranja++;
                                } else {
                                    statusMaq[maquina.id] = "Status Vermelho";
                                    contadorSttsVermelho++;
                                }

                            } else {
                                graficos[maquina.id].data.labels.shift()
                                graficos[maquina.id].data.datasets[0].data.shift()
                                graficos[maquina.id].data.datasets[1].data.shift()
                                graficos[maquina.id].data.datasets[2].data.shift()
                                graficos[maquina.id].data.labels.push(dataHora[0])
                                graficos[maquina.id].data.datasets[0].data.push(usoProcessador[0])
                                graficos[maquina.id].data.datasets[1].data.push(usoDisco[0])
                                graficos[maquina.id].data.datasets[2].data.push(usoRam[0])

                                graficos[maquina.id].update();

                                if (statusMaq[maquina.id] == "Status Verde") {
                                    if (usoDisco[0] <= 50 && usoProcessador[0] <= 50 && usoRam[0] <= 50) {
                                        statusMaq[maquina.id] = "Status Verde";
                                
                                    } else if (usoDisco[0] <= 65 && usoProcessador[0] <= 65 && usoRam[0] <= 65) {
                                        statusMaq[maquina.id] = "Status Amarelo";
                                        contadorSttsAmarelo.innerHTML++;
                                        contadorSttsVerde.innerHTML--;
                                    } else if (usoDisco[0] <= 75 && usoProcessador[0] <= 75 && usoRam[0] <= 75) {
                                        statusMaq[maquina.id] = "Status Laranja";
                                        contadorSttsLaranja.innerHTML++;
                                        contadorSttsVerde.innerHTML--;
                                    } else {
                                        statusMaq[maquina.id] = "Status Vermelho";
                                        contadorSttsVermelho.innerHTML++;
                                        contadorSttsVerde.innerHTML--;
                                    }

                                }

                                if (statusMaq[maquina.id] == "Status Amarelo") {
                                    if (usoDisco[0] <= 50 && usoProcessador[0] <= 50 && usoRam[0] <= 50) {
                                        statusMaq[maquina.id] = "Status Verde";
                                        contadorSttsVerde.innerHTML++;
                                        contadorSttsAmarelo.innerHTML--;
                                
                                    } else if (usoDisco[0] <= 65 && usoProcessador[0] <= 65 && usoRam[0] <= 65) {
                                        statusMaq[maquina.id] = "Status Amarelo";
                                     
                                    } else if (usoDisco[0] <= 75 && usoProcessador[0] <= 75 && usoRam[0] <= 75) {
                                        statusMaq[maquina.id] = "Status Laranja";
                                        contadorSttsLaranja.innerHTML++;
                                        contadorSttsAmarelo.innerHTML--;
                                    } else {
                                        statusMaq[maquina.id] = "Status Vermelho";
                                        contadorSttsVermelho.innerHTML++;
                                        contadorSttsAmarelo.innerHTML--;
                                    }

                                }

                                if (statusMaq[maquina.id] == "Status Laranja") {
                                    if (usoDisco[0] <= 50 && usoProcessador[0] <= 50 && usoRam[0] <= 50) {
                                        statusMaq[maquina.id] = "Status Verde";
                                        contadorSttsVerde.innerHTML++;
                                        contadorSttsLaranja.innerHTML--;
                                
                                    } else if (usoDisco[0] <= 65 && usoProcessador[0] <= 65 && usoRam[0] <= 65) {
                                        statusMaq[maquina.id] = "Status Amarelo";
                                        contadorSttsAmarelo.innerHTML++;
                                        contadorSttsLaranja.innerHTML--;
                                     
                                    } else if (usoDisco[0] <= 75 && usoProcessador[0] <= 75 && usoRam[0] <= 75) {
                                        statusMaq[maquina.id] = "Status Laranja";
                                     
                                    } else {
                                        statusMaq[maquina.id] = "Status Vermelho";
                                        contadorSttsVermelho.innerHTML++;
                                        contadorSttsLaranja.innerHTML--;
                                    }

                                }

                                if (statusMaq[maquina.id] == "Status Vermelho") {
                                    if (usoDisco[0] <= 50 && usoProcessador[0] <= 50 && usoRam[0] <= 50) {
                                        statusMaq[maquina.id] = "Status Verde";
                                        contadorSttsVerde.innerHTML++;
                                        contadorSttsVermelho.innerHTML--;
                                
                                    } else if (usoDisco[0] <= 65 && usoProcessador[0] <= 65 && usoRam[0] <= 65) {
                                        statusMaq[maquina.id] = "Status Amarelo";
                                        contadorSttsAmarelo.innerHTML++;
                                        contadorSttsVermelho.innerHTML--;
                                     
                                    } else if (usoDisco[0] <= 75 && usoProcessador[0] <= 75 && usoRam[0] <= 75) {
                                        statusMaq[maquina.id] = "Status Laranja";
                                        contadorSttsLaranja.innerHTML++;
                                        contadorSttsVermelho.innerHTML--;
                                    } else {
                                        statusMaq[maquina.id] = "Status Vermelho";
                                    }

                                }

                            }
                        });
                    }

                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }


            }).catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
        }

        var ramFlat = 0;
        var disco = 0;

        function informacoesMaquina(url) {
                fetch(`/medidas/listar-maquina/${url}`, { cache: 'no-store' }).then(function (response) {
                    if (response.ok) {
                        response.json().then(function (resposta) {
                            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                            resposta.reverse();
                            console.log(resposta);



                            ramFlat = resposta[0].memoriaRam;
                            disco = resposta[0].espacoDisco;
                        });
                    } else {
                        console.error('Nenhum dado encontrado ou erro na API');
                    }
                })
                    .catch(function (error) {
                        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                    });
            }




    </script>
    <script>
        b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
        setor_usuario.innerHTML = sessionStorage.SETOR_USUARIO;

        let list = document.querySelectorAll('.list');
        for (let i = 0; i < list.length; i++) {
            list[i].onclick = function () {
                let j = 0;
                while (j < list.length) {
                    list[j++].className = 'list';
                }
                list[i].className = 'list active';
            }
        }

        function listar_usu(usuarios) {

            contador.innerHTML = usuarios.length;
        }

        let btnSair = document.getElementById("sair")
        btnSair.addEventListener("click", functionSair);

        function functionSair() {
            Swal.fire({
                title: 'Deseja realmente sair?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sim',
                cancelButtonText: 'Não, sair'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location = "../Home/index.html";
                }
            })
        }

    </script>
</body>

</html>